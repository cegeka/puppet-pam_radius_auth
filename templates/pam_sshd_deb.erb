# This file is managed by Puppet.
#
# PAM configuration for the Secure Shell service

# Read environment variables from /etc/environment and
# /etc/security/pam_env.conf.
auth       required     pam_env.so # [1]
# In Debian 4.0 (etch), locale-related environment variables were moved to
# /etc/default/locale, so read that as well.
auth       required     pam_env.so envfile=/etc/default/locale

# libpam-radius-auth
<%- if @pam_radius_enforce_real == 'strict'-%>
# strict - don't allow failback to local password
auth       [success=1 default=ignore] pam_listfile.so onerr=fail item=user sense=allow <%- @pam_radius_authorized.each do |key,value| -%>file=/etc/pam_admin_users_<%= key %>.conf <%- end %>
auth       [success=1 default=ignore] pam_succeed_if.so <%- @pam_radius_authorized.each do |key,value| -%> user notingroup <%= key %> <%- end %> quiet
auth       [success=done new_authtok_reqd=done ignore=ignore default=die] pam_radius_auth.so localifdown
auth       sufficient   pam_unix.so nullok
<% end -%>
<%- if @pam_radius_enforce_real == 'permissive'-%>
# permissive - allow failback to local password
auth       sufficient   pam_radius_auth.so localifdown
auth       sufficient   pam_unix.so nullok use_first_pass
<% end -%>

# Standard Un*x authentication.
@include common-auth

# Disallow non-root logins when /etc/nologin exists.
account    required     pam_nologin.so

# Uncomment and edit /etc/security/access.conf if you need to set complex
# access limits that are hard to express in sshd_config.
# account  required     pam_access.so

# Standard Un*x authorization.
@include common-account

# Standard Un*x session setup and teardown.
@include common-session

# Print the message of the day upon successful login.
session    optional     pam_motd.so # [1]

# Print the status of the user's mailbox upon successful login.
session    optional     pam_mail.so standard noenv # [1]

# Set up user limits from /etc/security/limits.conf.
session    required     pam_limits.so

# Set up SELinux capabilities (need modified pam)
# session  required     pam_selinux.so multiple

# Standard Un*x password updating.
@include common-password
